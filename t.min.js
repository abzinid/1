 <script>

        function open_new_tab(url) {
            window.open(url, '_blank');
            return false;
        }

        tgw = {
            peer_id: '5ca385bd83ba88fb098b4567',
            lock_get_history: false,
            ajax_process: '<div class="messages_loader"><img src="images/loading.gif?v=1" /></div>',
            count_max_request: 60,
            count_exec_request: 0,

            render: function () {
                $('.tg-body').css({
                    'height': $(window).height() - $('.tg-head').outerHeight() - $('.btn-footer-line').outerHeight()
                })

                // max-width for post
                var w = $(window).width() - 46;
                if(w < 432) {
                    $('.post-body').css({
                        'max-width': w
                    })
                }
            },

            // удалить сообщение
            remove_update: function (update_id, date) {
                $('.remove_btn_' + update_id).hide();
                $('.remove_loading_' + update_id).show();
                $.ajax({
                    url: '/widget/action/index.php',
                    type: 'POST',
                    data: {
                        action: 'remove_update',
                        update_id: update_id,
                        token: '2a2e1742e803e7d3483ba46b3b094872',
                        widget_id: '5ca385bd83ba88fb098b4567'
                    },
                    cache: false,
                    success: function (data) {
                        $('.remove_loading_' + update_id).hide();
                        if (parseInt(data) == 1) {
                            $('.tgw_item[data-update_id="' + date + '"]').remove();
                        } else {
                            $('.remove_btn_' + update_id).show();
                        }
                    },
                    fail: function () {
                        $('.remove_btn_' + update_id).show();
                        $('.remove_loading_' + update_id).hide();
                    }
                })
            },

            // подгрузить историю сообщений
            get_history: function () {

                if($('.tg-body').size()){

                    tgw.lock_get_history = true;

                    $('.tg-body').prepend(tgw.ajax_process);

                    var update_id = $(".tgw_item:eq(0)").attr('data-update_id');

                    $.ajax({
                        url: '/channel/v2.0/index.php',
                        type: 'POST',
                        cache: false,
                        data: {
                            id: tgw.peer_id,
                            update_id: update_id,
                            type: 'history',
                            hl: 'en'
                        },
                        success: function (data) {
                            $('.messages_loader').remove();
                            $('.tg-body').prepend(data);
                            tgw.lock_get_history = false;
                        },
                        error: function () {
                            $('.messages_loader').remove();
                            tgw.lock_get_history = false;
                        }
                    })
                }
            },

            // загрузка последних сообщений
            get_latest_messages: function () {

                $('.tg-body').html(tgw.ajax_process);

                $.ajax({
                    url: '/channel/v2.0/index.php',
                    type: 'POST',
                    cache: false,
                    data: {
                        id: tgw.peer_id,
                        type: 'latest',
                        hl: 'en'
                    },
                    success: function (data) {
                        $('.tg-body').html(data);

                        tgw.render();

                        // scroll в низ
                        tgw.scroll_to_last_message();
                    },
                    error: function () {
                        $('.messages_loader').remove();
                    }
                })
            },

            // проверка наличия новых сообщений
            get_new_messages: function () {

                if(tgw.count_exec_request >= tgw.count_max_request)
                    return false;

                // последнее сообщение
                var last_update_id = 0;
                if ($('.tgw_item').size()) {
                    last_update_id = $(".tgw_item:eq(" + ($('.tgw_item').size() - 1) + ")").attr('data-update_id');
                }

                // последняя временная отметка в сообщениях
                var last_day = '';
                if ($('.tgw_day_separate').size()) {
                    last_day = $(".tgw_day_separate:eq(" + ($('.tgw_day_separate').size() - 1) + ")").attr('data-value');
                }

                tgw.count_exec_request++;

                $.ajax({
                    url: '/channel/v2.0/index.php',
                    type: 'POST',
                    cache: false,
                    data: {
                        id: tgw.peer_id,
                        update_id: last_update_id,
                        last_day: last_day,
                        type: 'new',
                        hl: 'en'
                    },
                    success: function (data) {

                        $('.tg-body').append(data);

                        // удалим первый script
                        if ($('.get_new_message').size() > 1)
                            $('.get_new_message:eq(0)').remove();
                    },
                    error: function () {
                        //$('.messages_loader').hide();
                    }
                })
            },

            // scroll к самому последнему сообщению
            scroll_to_last_message: function () {

                $('.tg-body').scrollTop($('.tg-body').prop('scrollHeight'));

                // scroll вниз после загрузки всех картинок
                $('img').one('load', function () {
                    $('.tg-body').scrollTop($('.tg-body').prop('scrollHeight'));
                })
            }
        }

        $(function () {

            tgw.render();

            $(window).on('resize', function () {
                tgw.render()
            })

            // получить последние сообщения
            tgw.get_latest_messages();

            // проверяем наличие новых сообщений
            setTimeout(function () {
                tgw.get_new_messages();
            }, 5000);

            // история сообщений
            $('.tg-body').on('scroll', function () {
                if(
                    $(this).scrollTop() == 0
                    && tgw.lock_get_history == false
                    && $('.tg-body').size() > 0
                ){
                    tgw.get_history();
                }
            })
        })
    </script>
